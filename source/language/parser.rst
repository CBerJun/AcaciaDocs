语言解析
==============

行结构
------------

一个 Acacia 程序由多个 :dfn:`逻辑行` 组成。

逻辑行
^^^^^^^^^^

一个逻辑行是由一个或多个 :dfn:`物理行` 通过续行而成的。

物理行
^^^^^^^^^^

一个物理行指源文件中的一串由 ``\n`` 换行符或文件结束结尾的一串字符。

注释
^^^^^^^^^^

Acacia 中有以下这些注释，它们会被编译器忽略:

    * 由后面非 ``*`` 字符的 ``#`` 字符开始直至物理行结束的单行注释
    * 由紧贴着的 ``#*`` 开始，由 ``*#`` 结束的多行注释

显式续行
^^^^^^^^^^

当一个物理行以 ``\`` 字符结束时（其后只允许空格符），除非它在注释中，否则它就会将该行与下一行拼接为一个逻辑行::

    if a == 0 and \
       b != 10 and \
       not a > 0:
            pass

此处拼接是形符（token）层面的拼接，而不是字符层面的。例如::

    a := 1\
    0

是无效的，而不会被解释为 ``a := 10``\ 。

隐式续行
^^^^^^^^^^

``()``\ 、\ ``[]`` 以及 ``{}`` 之间的内容可以分成多个物理行::

    month_names -> {
        # 3-letter abbreviations of months
        "Jan", "Feb", "Mar",
        "Apr", "May", "Jun",
        "Jul", "Aug", "Sep",
        "Oct", "Nov", "Dec"
    }

它相比显式续行的好处在于可以添加注释，允许空白行。

缩进
^^^^^^^^^^

逻辑行开头的空格符用于计算该行的缩进层级，决定语句组块。制表符是不允许的。行的缩进层级以堆栈形式生成 ``INDENT`` 和 ``DEDENT`` 形符，说明如下。

读取文件第一行前，先向栈推入一个零值，该零值不会被移除。推入栈的层级值从底至顶持续增加。每个逻辑行开头的行缩进层级将与栈顶行比较。如果相等，则不做处理。如果新行层级较高，则会被推入栈顶，并生成一个 ``INDENT`` 形符。如果新行层级较低，则应当是栈中的层级数值之一；栈中高于该层级的所有数值都将被移除，每移除一级数值生成一个 ``DEDENT`` 形符。文件末尾，栈中剩余的每个大于零的数值生成一个 ``DEDENT`` 形符。

以下是一个正确缩进的例子::

    def is_prime(x: int) -> bool:
        #* Test if an integer is a prime number. `x` must >= 2. *#
        result = True
        mod := 2
        while mod <= x / 2 and result:
            result = (x % mod == 0)
            mod += 1

标识符和关键字
---------------------

标识符应当由大小写字母 ``a-z`` 和 ``A-Z``\ 、数字 ``0-9`` 和下划线 ``_`` 组成，但不能以数字开头。标识符是大小写敏感的。


关键字
^^^^^^^^^^

以下标识符为 :dfn:`关键字`\ ，有特殊含义，不可用于普通标识符:

.. hlist::
    :columns: 4

    * ``True``
    * ``def``
    * ``interface``
    * ``inline``
    * ``entity``
    * ``extends``
    * ``self``
    * ``if``
    * ``elif``
    * ``else``
    * ``while``
    * ``pass``
    * ``and``
    * ``or``
    * ``not``
    * ``result``
    * ``import``
    * ``as``
    * ``from``
    * ``None``
    * ``for``
    * ``in``
    * ``struct``
    * ``virtual``
    * ``override``
    * ``False``

被保留的标识符
^^^^^^^^^^^^^^^^^

``__*__`` 形式的标识符是用于和语言核心交互的，各名称的含义由解释器和标准库定义。任何情况下不遵循文档的使用都可能在当前或未来的版本引起问题。


字面值
---------------------

字面值是内置类型常量值的表示法。

整数字面值
^^^^^^^^^^^^^

Acacia 支持以下的整数字面值:

* 由一个或多个 ``0`` 至 ``9`` 数字字符组成的十进制数。以多余的 ``0`` 开头是允许的，会被忽略。
* 由 ``0x`` 开头，加上一个或多个 ``0`` 至 ``9``\ 、\ ``a`` 至 ``f``\ 或 ``A`` 至 ``F`` 字符组成的十六进制数。大小写没有区别。
* 由 ``0b`` 开头，加上一个或多个 ``0`` 或 ``1`` 字符组成的二进制数。
* 由 ``0o`` 开头，加上一个或多个 ``0`` 至 ``7`` 字符组成的二进制数。

``-1`` 实际上是由一元运算符 ``-`` 与字面值 ``1`` 组合起来的。整数字面值的大小在词法分析时无限制，但是作为内置整型使用时（如赋值给整形变量时）应当控制在 32 位有符号整数范围内，即 :math:`-2^{32} <= value < 2^{32}`\ 。

示例::

    7
    103
    0b0001100
    0xcafebabe
    0o777

浮点数字面值
^^^^^^^^^^^^^^^^^

Acacia 中的浮点数字面值是由一个合法的十进制整数字面值，紧贴着一个 ``.`` 字符，再紧贴着一个十进制整数字面值组成的。

例如::

    2.345
    0.00124
    23.8

字符串字面值
^^^^^^^^^^^^^^^^^

字符串字面值是由两个双引号 ``""`` 之间包裹着的字符内容。字符串的值就是引号之间的字符，但有以下例外，称为 :dfn:`转义`:

    * ``\\`` 会被解读为反斜杠字符 ``\``。
    * ``\"`` 会被解读为双引号字符 ``"``。
    * 以下转义会按照输入的数字按照 Unicode 编码转换为单个字符，其中的 ``H`` 是一位十六进制数位，类似十六进制字面值，不区分大小写:

        - :samp:`\\x{HH}` 
        - :samp:`\\u{HHHH}`
        - :samp:`\\U{HHHHHHHH}`\ ，大小不超过 ``0x10FFFF``\ 。

    * ``\#`` 转义生成用于给 Minecraft 中的文字上色的序列（详见 :mcwiki:`格式化代码`）:

        - 后面跟着非 ``(`` 字符的 ``\#`` 生成分节符号 ``§``。举例::

            "\#aBright Green\#rNormal"

        - :samp:`\\#({...})` 根据 ``...`` 的颜色和格式选择生成 Minecraft 使用的格式化代码。\ ``...`` 是由 ``,`` 字符分隔的多个格式选择词，词的两边允许空格符，但尾逗号不允许，Acacia 将会按照顺序生成各个格式选择词对应的代码字符，如 ``\#(green, bold)``\ 。所有可用的格式选择词及对应的 Minecraft 代码字符如下:

            ..
                Generated by Python script:
                    for name, c in d.items():
                        print("%-23s ``%s``          " % ("``%s``" % name, c))

            ======================= ============== ===========
            格式选择词               代码字符        含义
            ======================= ============== ===========
            ``reset``               ``r``          重置
            ``bold``                ``l``          粗体
            ``italic``              ``o``          斜体
            ``obfuscated``          ``k``          乱码
            ``black``               ``0``          黑色
            ``dark_blue``           ``1``          深蓝色
            ``dark_green``          ``2``          深绿色
            ``dark_aqua``           ``3``          深水蓝色
            ``dark_red``            ``4``          深红色
            ``dark_purple``         ``5``          深紫色
            ``gold``                ``6``          亮金色
            ``gray``                ``7``          灰色
            ``dark_gray``           ``8``          深灰色
            ``blue``                ``9``          蓝色
            ``green``               ``a``          绿色
            ``aqua``                ``b``          水蓝色
            ``red``                 ``c``          红色
            ``light_purple``        ``d``          淡紫色
            ``yellow``              ``e``          黄色
            ``white``               ``f``          白色
            ``minecoin_gold``       ``g``          硬币金色
            ``material_quartz``     ``h``          石英色
            ``material_iron``       ``i``          铁色
            ``material_netherite``  ``j``          下界合金色
            ``material_redstone``   ``m``          红石色
            ``material_copper``     ``n``          铜色
            ``material_gold``       ``p``          金色
            ``material_emerald``    ``q``          绿宝石色
            ``material_diamond``    ``s``          钻石色
            ``material_lapis``      ``t``          青金石色
            ``material_amethyst``   ``u``          紫水晶色
            ======================= ============== ===========
